name: ⭐ Update by language
on:
  push:
    branches: [main]
  schedule:
    - cron: 0/30 * * * *
  workflow_dispatch:
jobs:
  update-by-language:
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPOSITORY: ${{ env.REPOSITORY_NAME }}
      USERNAME: ${{ github.repository_owner }}
    name: 🌟 Update stars and clean old runs
    runs-on: ubuntu-latest
    steps:
      - name: 🧹 Delete old workflow runs
        run: |
          gh api repos/${{ github.repository }}/actions/runs --paginate -q '.workflow_runs[] \
          | select(.status != "in_progress" and .status != "queued") | "\(.id)"' \
          | xargs -I % gh api repos/${{ github.repository }}/actions/runs/% -X DELETE

      - name: ⬇ Checkout
        uses: actions/checkout@v5
        
      - name: 🔧 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: 🔧 Install dependencies
        run: pip install --upgrade pip starred

      - name: ⭐ Update repo category by language
        run: |
          starred \
            --token ${GITHUB_TOKEN} \
            --username ${USERNAME} \
            --sort > by-language.md
          head by-language.md
          if [ $(wc -l < "by-language.md") -lt 100 ]; then
            git checkout -- "by-language.md"
          fi

      - name: 🤖 Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 🤖 Update generated README/topics
          branch: main
          commit_user_name: awesome-stars 🤖
          commit_user_email: actions@github.com
          commit_author: awesome-stars 🤖 <actions@github.com>
